rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isValidSetup() {
      return request.resource.data.keys().hasAll(['name', 'ownerId', 'createdAt', 'devices'])
        && request.resource.data.name is string
        && request.resource.data.ownerId is string
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.createdAt is timestamp
        && request.resource.data.devices is list;
    }

    function isValidDevice() {
      return request.resource.data.keys().hasAll(['name', 'type', 'ownerId'])
        && request.resource.data.name is string
        && request.resource.data.type is string
        && request.resource.data.ownerId is string
        && request.resource.data.ownerId == request.auth.uid;
    }

    function isValidProduct() {
      return request.resource.data.keys().hasAll(['name', 'type', 'ownerId'])
        && request.resource.data.name is string
        && request.resource.data.type is string
        && request.resource.data.ownerId is string
        && request.resource.data.ownerId == request.auth.uid
        && (!('modelPath' in request.resource.data) || request.resource.data.modelPath is string);
    }

    // Products
    match /products/{productId} {
      allow read: if true;
      allow create: if isSignedIn() && isValidProduct();
      allow update: if isSignedIn() && (resource.data.ownerId == request.auth.uid || request.auth.token.admin == true);
      allow delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || request.auth.token.admin == true);
    }

    // User profiles
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isOwner(userId);
      // Followers: anyone can add/remove themselves as follower of userId
      match /followers/{followerId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.auth.uid == followerId;
        allow delete: if isSignedIn() && request.auth.uid == followerId;
      }
      // Notifications: only owner can read/update/delete; creator can create (fromUserId == auth.uid)
      match /notifications/{notificationId} {
        allow read, update, delete: if isSignedIn() && request.auth.uid == userId;
        allow create: if isSignedIn() && request.resource.data.fromUserId == request.auth.uid;
      }
    }

    // Setups (saved rig configs)
    match /setups/{setupId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidSetup();
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    // Devices
    match /devices/{deviceId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidDevice();
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    // Connections
    match /connections/{connectionId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Clips (short-form feed videos)
    match /clips/{clipId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
    }

    // Sets (full live set references)
    match /sets/{setId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
    }
  }
}
